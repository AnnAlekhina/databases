DROP DATABASE IF EXISTS VK;
CREATE DATABASE VK;
USE VK;

DROP TABLE IF EXISTS USERS;
CREATE TABLE USERS (
	ID BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY, 
    FIRSTNAME VARCHAR(50),
    LASTNAME VARCHAR(50) COMMENT '–§–∞–£–®–ª—å', -- COMMENT –Ω–∞ —Å–ª—Å—á–∞–π, –?—Å–ª–® –®–£—è –Ω–?–Ω—á–?–≤–®–•–Ω–Ω–?
    EMAIL VARCHAR(120) UNIQUE,
 	PASSWORD_HASH VARCHAR(100), -- 123456 => VZX;CLVGKAJRPO9UDFXVSLDKRN24L5456345T
	PHONE BIGINT UNSIGNED UNIQUE, 
	
    INDEX USERS_FIRSTNAME_LASTNAME_IDX(FIRSTNAME, LASTNAME)
) COMMENT '—é–∑–?—Ä—ã';

DROP TABLE IF EXISTS `PROFILES`;
CREATE TABLE `PROFILES` (
	USER_ID BIGINT UNSIGNED NOT NULL UNIQUE,
    GENDER CHAR(1),
    BIRTHDAY DATE,
	PHOTO_ID BIGINT UNSIGNED NULL,
    CREATED_AT DATETIME DEFAULT NOW(),
    HOMETOWN VARCHAR(100)
	
    -- , FOREIGN KEY (PHOTO_ID) REFERENCES MEDIA(ID) -- –Ø–Ω–™–∞ —Ä–∞–Ω–Ω, —Ç.–™. —Ç–∞–±–ª–®—Ü—ã MEDIA –?—â–? –Ω–?—Ç
);

ALTER TABLE `PROFILES` ADD CONSTRAINT FK_USER_ID
    FOREIGN KEY (USER_ID) REFERENCES USERS(ID)
    ON UPDATE CASCADE -- (–∑–Ω–∞—á–?–Ω–®–? –Ø–Ω —Å–£–Ω–ª—á–∞–Ω–®—é)
    ON DELETE RESTRICT; -- (–∑–Ω–∞—á–?–Ω–®–? –Ø–Ω —Å–£–Ω–ª—á–∞–Ω–®—é)

DROP TABLE IF EXISTS MESSAGES;
CREATE TABLE MESSAGES (
	ID SERIAL, -- SERIAL = BIGINT UNSIGNED NOT NULL AUTO_INCREMENT UNIQUE
	FROM_USER_ID BIGINT UNSIGNED NOT NULL,
    TO_USER_ID BIGINT UNSIGNED NOT NULL,
    BODY TEXT,
    CREATED_AT DATETIME DEFAULT NOW(), -- –£–Ω–∂–Ω–Ω –±—Å–•–?—Ç –•–∞–∂–? –Ω–? —Å–Ø–Ω–£–®–Ω–∞—Ç—å —ç—Ç–Ω –Ø–Ω–ª–? –Ø—Ä–® –≤—Å—Ç–∞–≤–™–?

    FOREIGN KEY (FROM_USER_ID) REFERENCES USERS(ID),
    FOREIGN KEY (TO_USER_ID) REFERENCES USERS(ID)
);

DROP TABLE IF EXISTS FRIEND_REQUESTS;
CREATE TABLE FRIEND_REQUESTS (
	-- ID SERIAL, -- –®–∑–£–?–Ω–®–ª–® –Ω–∞ —Å–Ω—Å—Ç–∞–≤–Ω–Ω–π –™–ª—é—á (INITIATOR_USER_ID, TARGET_USER_ID)
	INITIATOR_USER_ID BIGINT UNSIGNED NOT NULL,
    TARGET_USER_ID BIGINT UNSIGNED NOT NULL,
    `STATUS` ENUM('REQUESTED', 'APPROVED', 'DECLINED', 'UNFRIENDED'),
    -- `STATUS` TINYINT(1) UNSIGNED, -- –≤ —ç—Ç–Ω–£ —Å–ª—Å—á–∞–? –≤ –™–Ω–•–? —Ö—Ä–∞–Ω–®–ª–® –±—ã —Ü–®—Ñ–®—Ä–Ω—ã–π ENUM (0, 1, 2, 3...)
	REQUESTED_AT DATETIME DEFAULT NOW(),
	UPDATED_AT DATETIME ON UPDATE CURRENT_TIMESTAMP, -- –£–Ω–∂–Ω–Ω –±—Å–•–?—Ç –•–∞–∂–? –Ω–? —Å–Ø–Ω–£–®–Ω–∞—Ç—å —ç—Ç–Ω –Ø–Ω–ª–? –Ø—Ä–® –Ω–±–Ω–Ω–≤–ª–?–Ω–®–®
	
    PRIMARY KEY (INITIATOR_USER_ID, TARGET_USER_ID),
    FOREIGN KEY (INITIATOR_USER_ID) REFERENCES USERS(ID),
    FOREIGN KEY (TARGET_USER_ID) REFERENCES USERS(ID)-- ,
    -- CHECK (INITIATOR_USER_ID <> TARGET_USER_ID)
);
-- —á—Ç–Ω–±—ã –Ø–Ω–ª—å–∑–Ω–≤–∞—Ç–?–ª—å —Å–∞–£ —Å–?–±–? –Ω–? –Ω—Ç–Ø—Ä–∞–≤–®–ª –∑–∞–Ø—Ä–Ω—Å –≤ –•—Ä—Å–∑—å—è
ALTER TABLE FRIEND_REQUESTS 
ADD CHECK(INITIATOR_USER_ID <> TARGET_USER_ID);

DROP TABLE IF EXISTS COMMUNITIES;
CREATE TABLE COMMUNITIES(
	ID SERIAL,
	NAME VARCHAR(150),
	ADMIN_USER_ID BIGINT UNSIGNED NOT NULL,
	
	INDEX COMMUNITIES_NAME_IDX(NAME), -- –®–Ω–•–?–™—Å—Å –£–Ω–∂–Ω–Ω –•–∞–≤–∞—Ç—å —Å–≤–Ω–? –®–£—è (COMMUNITIES_NAME_IDX)
	FOREIGN KEY (ADMIN_USER_ID) REFERENCES USERS(ID)
);

DROP TABLE IF EXISTS USERS_COMMUNITIES;
CREATE TABLE USERS_COMMUNITIES(
	USER_ID BIGINT UNSIGNED NOT NULL,
	COMMUNITY_ID BIGINT UNSIGNED NOT NULL,
  
	PRIMARY KEY (USER_ID, COMMUNITY_ID), -- —á—Ç–Ω–±—ã –Ω–? –±—ã–ª–Ω 2 –∑–∞–Ø–®—Å–?–π –Ω –Ø–Ω–ª—å–∑–Ω–≤–∞—Ç–?–ª–? –® —Å–Ω–Ω–±—â–?—Å—Ç–≤–?
    FOREIGN KEY (USER_ID) REFERENCES USERS(ID),
    FOREIGN KEY (COMMUNITY_ID) REFERENCES COMMUNITIES(ID)
);

DROP TABLE IF EXISTS MEDIA_TYPES;
CREATE TABLE MEDIA_TYPES(
	ID SERIAL,
    NAME VARCHAR(255), -- –∑–∞–Ø–®—Å–?–π –£–∞–ª–Ω, –Ø–Ω—ç—Ç–Ω–£—Å –≤ –®–Ω–•–?–™—Å–? –Ω–?—Ç –Ω–?–Ω–±—Ö–Ω–•–®–£–Ω—Å—Ç–®
    CREATED_AT DATETIME DEFAULT NOW(),
    UPDATED_AT DATETIME ON UPDATE CURRENT_TIMESTAMP
);

DROP TABLE IF EXISTS MEDIA;
CREATE TABLE MEDIA(
	ID SERIAL,
    MEDIA_TYPE_ID BIGINT UNSIGNED NOT NULL,
    USER_ID BIGINT UNSIGNED NOT NULL,
  	BODY TEXT,
    FILENAME VARCHAR(255),
    -- FILE BLOB,    	
    SIZE INT,
	METADATA JSON,
    CREATED_AT DATETIME DEFAULT NOW(),
    UPDATED_AT DATETIME ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (USER_ID) REFERENCES USERS(ID),
    FOREIGN KEY (MEDIA_TYPE_ID) REFERENCES MEDIA_TYPES(ID)
);

DROP TABLE IF EXISTS LIKES;
CREATE TABLE LIKES(
	ID SERIAL,
    USER_ID BIGINT UNSIGNED NOT NULL,
    MEDIA_ID BIGINT UNSIGNED NOT NULL,
    CREATED_AT DATETIME DEFAULT NOW()

    -- PRIMARY KEY (USER_ID, MEDIA_ID) ¬Äì –£–Ω–∂–Ω–Ω –±—ã–ª–Ω –® —Ç–∞–™ –≤–£–?—Å—Ç–Ω ID –≤ –™–∞—á–?—Å—Ç–≤–? PK
  	-- —Å–ª–®—à–™–Ω–£ —Å–≤–ª–?–™–∞—Ç—å—Å—è –®–Ω–•–?–™—Å–∞–£–® —Ç–Ω–∂–? –Ω–Ø–∞—Å–Ω–Ω, —Ä–∞—Ü–®–Ω–Ω–∞–ª—å–Ω–?–? –®—Ö –•–Ω–±–∞–≤–ª—è—Ç—å –Ø–Ω –£–?—Ä–? –Ω–?–Ω–±—Ö–Ω–•–®–£–Ω—Å—Ç–® (–Ω–∞–Ø—Ä., –Ø—Ä–Ω–≤–®—Å–∞—é—Ç –Ø–Ω –≤—Ä–?–£–?–Ω–® –™–∞–™–®–?-—Ç–Ω –∑–∞–Ø—Ä–Ω—Å—ã)  

/* –Ω–∞–£–?—Ä–?–Ω–Ω–Ω –∑–∞–±—ã–ª–®, —á—Ç–Ω–±—ã –Ø–Ω–∑–•–Ω–?–? —Å–≤–®–•–?—Ç—å –®—Ö –Ω—Ç—Å—Å—Ç—Å—Ç–≤–®–? –≤ ER-–•–®–∞–≤—Ä–∞–£–£–?
    , FOREIGN KEY (USER_ID) REFERENCES USERS(ID)
    , FOREIGN KEY (MEDIA_ID) REFERENCES MEDIA(ID)
*/
);

DROP TABLE IF EXISTS `PHOTO_ALBUMS`;
CREATE TABLE `PHOTO_ALBUMS` (
	`ID` SERIAL,
	`NAME` VARCHAR(255) DEFAULT NULL,
    `USER_ID` BIGINT UNSIGNED DEFAULT NULL,

    FOREIGN KEY (USER_ID) REFERENCES USERS(ID),
  	PRIMARY KEY (`ID`)
);

DROP TABLE IF EXISTS `PHOTOS`;
CREATE TABLE `PHOTOS` (
	ID SERIAL,
	`ALBUM_ID` BIGINT UNSIGNED NULL,
	`MEDIA_ID` BIGINT UNSIGNED NOT NULL,

	FOREIGN KEY (ALBUM_ID) REFERENCES PHOTO_ALBUMS(ID),
    FOREIGN KEY (MEDIA_ID) REFERENCES MEDIA(ID)
);

ALTER TABLE VK.LIKES 
ADD CONSTRAINT LIKES_FK 
FOREIGN KEY (MEDIA_ID) REFERENCES VK.MEDIA(ID);

ALTER TABLE VK.LIKES 
ADD CONSTRAINT LIKES_FK_1 
FOREIGN KEY (USER_ID) REFERENCES VK.USERS(ID);

ALTER TABLE VK.PROFILES 
ADD CONSTRAINT PROFILES_FK_1 
FOREIGN KEY (PHOTO_ID) REFERENCES MEDIA(ID);
